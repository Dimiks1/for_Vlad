@page
@{
    ViewData["Title"] = "Настройки профиля";
}

<div class="container py-5">
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-cog me-2"></i> Настройки профиля</h5>
                </div>
                <div class="card-body">
                    <!-- Информация о пользователе -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Информация об аккаунте</h6>
                            <div class="mb-3">
                                <label class="form-label">Никнейм</label>
                                <input type="text" class="form-control" id="username" value="Загрузка..." disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="Загрузка..." disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Дата регистрации</label>
                                <input type="text" class="form-control" id="createdAt" value="Загрузка..." disabled>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info h-100 d-flex flex-column justify-content-center">
                                <h5 class="alert-heading">Текущий баланс</h5>
                                <h2 class="mb-0" id="balanceDisplay">Загрузка...</h2>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="openDepositModal()">Пополнить баланс</button>
                                    <button class="btn btn-outline-danger ms-2" onclick="logout()">Выйти</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Изменение пароля -->
                    <h5 class="mb-3">Смена пароля</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Текущий пароль</label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="Введите текущий пароль">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Новый пароль</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="Введите новый пароль">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Подтвердите новый пароль</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Повторите новый пароль">
                            </div>
                            <button class="btn btn-primary" onclick="changePassword()">Изменить пароль</button>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i> Внимание!</h6>
                                <p class="mb-2 small">• Пароль должен содержать минимум 6 символов</p>
                                <p class="mb-2 small">• После смены пароля потребуется войти заново</p>
                                <p class="mb-0 small">• Рекомендуем использовать сложные пароли</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- История заказов -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i> История заказов</h5>
                </div>
                <div class="card-body">
                    <div id="ordersList" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3">Загружаем историю заказов...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно пополнения баланса -->
<div class="modal fade" id="depositModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Пополнение баланса</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Сумма пополнения (₽)</label>
                    <input type="number" class="form-control" id="depositAmount" value="100" min="10" max="10000">
                </div>
                <div class="alert alert-info">
                    <p class="mb-0 small">Минимальная сумма пополнения: 10 ₽<br>Максимальная сумма: 10 000 ₽</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="processDeposit()">Пополнить</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
        loadUserProfile();
        loadUserOrders();
    });

    // Загрузка профиля пользователя
    async function loadUserProfile() {
        try {
            const response = await fetch('/api/account/me');

            if (response.ok) {
                const data = await response.json();
                const user = data.user;

                if (user) {
                    // Заполняем данные на странице
                    document.getElementById('username').value = user.username;
                    document.getElementById('email').value = user.email;
                    document.getElementById('balanceDisplay').textContent = user.balance + ' ₽';

                    // Форматируем дату регистрации
                    if (user.createdAt) {
                        try {
                            const date = new Date(user.createdAt);
                            const formattedDate = date.toLocaleDateString('ru-RU', {
                                day: 'numeric',
                                month: 'long',
                                year: 'numeric'
                            });
                            document.getElementById('createdAt').value = formattedDate;
                        } catch (e) {
                            console.error('Ошибка форматирования даты:', e);
                            document.getElementById('createdAt').value = user.createdAt;
                        }
                    } else {
                        document.getElementById('createdAt').value = 'Неизвестно';
                    }
                } else {
                    // Если нет данных пользователя, перенаправляем на главную
                    window.location.href = '/';
                }
            } else {
                // Если не авторизован, перенаправляем на главную
                window.location.href = '/';
            }
        } catch (error) {
            console.error('Ошибка при загрузке профиля:', error);
            alert('Ошибка при загрузке данных профиля');
        }
    }

    // Загрузка истории заказов
    async function loadUserOrders() {
        try {
            const response = await fetch('/api/order/user-orders');

            if (response.ok) {
                const data = await response.json();
                const ordersContainer = document.getElementById('ordersList');

                if (data.orders && data.orders.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>ID</th><th>Дата</th><th>Сумма</th><th>Статус</th><th>Товаров</th><th></th></tr></thead><tbody>';

                    data.orders.forEach(order => {
                        let formattedDate = 'Неизвестно';
                        try {
                            const date = new Date(order.createdAt);
                            formattedDate = date.toLocaleDateString('ru-RU');
                        } catch (e) {
                            formattedDate = order.createdAt || 'Неизвестно';
                        }

                        html += `
                            <tr>
                                <td>#${order.id}</td>
                                <td>${formattedDate}</td>
                                <td>${order.totalPrice} ₽</td>
                                <td><span class="badge bg-info">${order.status}</span></td>
                                <td>${order.itemsCount}</td>
                                <td><button class="btn btn-sm btn-outline-primary" onclick="viewOrder(${order.id})">Детали</button></td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table></div>';
                    ordersContainer.innerHTML = html;
                } else {
                    ordersContainer.innerHTML = '<p class="text-muted">У вас пока нет заказов</p>';
                }
            }
        } catch (error) {
            console.error('Ошибка при загрузке заказов:', error);
            document.getElementById('ordersList').innerHTML = '<p class="text-danger">Ошибка при загрузке истории заказов</p>';
        }
    }

    // Смена пароля
    async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('Заполните все поля!');
            return;
        }

        if (newPassword.length < 6) {
            alert('Пароль должен содержать минимум 6 символов');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('Новые пароли не совпадают');
            return;
        }

        try {
            alert('Функция смены пароля находится в разработке');

            // Очищаем поля
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } catch (error) {
            console.error('Ошибка при смене пароля:', error);
            alert('Ошибка при смене пароля');
        }
    }

    // Открытие модального окна пополнения баланса
    function openDepositModal() {
        const depositModal = new bootstrap.Modal(document.getElementById('depositModal'));
        depositModal.show();
    }

    // Пополнение баланса
    async function processDeposit() {
        const amount = document.getElementById('depositAmount').value;

        if (!amount || amount < 10 || amount > 10000) {
            alert('Введите сумму от 10 до 10 000 ₽');
            return;
        }

        try {
            alert(`Запрос на пополнение на ${amount} ₽ отправлен.\nЭта функция находится в разработке.`);

            // Закрываем модальное окно
            const depositModal = bootstrap.Modal.getInstance(document.getElementById('depositModal'));
            depositModal.hide();
        } catch (error) {
            console.error('Ошибка при пополнении баланса:', error);
            alert('Ошибка при пополнении баланса');
        }
    }

    // Просмотр деталей заказа
    function viewOrder(orderId) {
        alert(`Детали заказа #${orderId}\nЭта функция находится в разработке.`);
    }

    // Выход из аккаунта
    async function logout() {
        if (confirm('Вы уверены, что хотите выйти?')) {
            try {
                const response = await fetch('/api/account/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    localStorage.removeItem('user');
                    localStorage.removeItem('cart');
                    alert('Вы вышли из системы');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Ошибка при выходе:', error);
            }
        }
    }
</script>